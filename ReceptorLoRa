#include "WiFi.h"
#include "Arduino.h"
#include "PubSubClient.h"
#include "LoRaWan_APP.h"

// ======================== CONFIGURACI√ìN WI-FI ========================
const char* ssid = "flia justiniano";
const char* password = "19662019";

// ======================== CONFIGURACI√ìN LORA ========================
#define RF_FREQUENCY 915000000
#define TX_OUTPUT_POWER 14
#define LORA_BANDWIDTH 0
#define LORA_SF 7
#define LORA_CR 1

#define LORA_PREAMBLE_LENGTH 8
#define LORA_SYMBOL_TIMEOUT 0
#define LORA_FIX_LENGTH_PAYLOAD_ON false
#define LORA_IQ_INVERSION_ON false
#define RX_TIMEOUT_VALUE 1000
#define BUFFER_SIZE 200

char rxpacket[BUFFER_SIZE];
static RadioEvents_t RadioEvents;
bool lora_idle = true;

// ======================== VARIABLES RECIBIDAS ========================
float testVoltage = 0.0;
float testCurrent = 0.0;
float testPower = 0.0;
float testConsumption = 0.0;
float testFWD = 0.0;
float testRFL = 0.0;
float testSWR = 0.0;
float testTemperature = 0.0;
float testHumidity = 0.0;
int   testSSR = 0;  // ESTADO DEL REL√â ENVIADO POR EL TX

// ============ VARIABLE PARA CONTROL REMOTO DEL REL√â ================
int remoteRelayState = 0;

// ======================== CONFIGURACI√ìN MQTT (ThingsBoard) ========================
const char* mqtt_server   = "mqtt.thingsboard.cloud";
const int   mqtt_port     = 1883;
const char* access_token  = "pik55c0x4sfp9idmxd17";

WiFiClient espClient;
PubSubClient client(espClient);

// ================ üïí INTERVALO DE ENV√çO (5 SEGUNDOS) =================
unsigned long lastSend = 0;
const long sendInterval = 5000;

// ============================= WIFI =============================
void setup_wifi() {
    Serial.println("Conectando a WiFi...");
    WiFi.begin(ssid, password);

    while (WiFi.status() != WL_CONNECTED) {
        delay(1000);
        Serial.print(".");
    }

    Serial.println("\nWiFi conectado");
    Serial.print("IP: ");
    Serial.println(WiFi.localIP());
}

// ===================== RPC CALLBACK =====================
// ThingsBoard ‚Üí ESP32 ‚Üí LoRa ‚Üí Transmisor
void rpcCallback(char* topic, byte* payload, unsigned int length) {
    payload[length] = '\0';

    String msg = String((char*)payload);

    Serial.print("RPC recibido: ");
    Serial.println(msg);

    if (msg.indexOf("method") > 0 && msg.indexOf("setRelay") > 0) {
        int val = msg.substring(msg.indexOf("params") + 8).toInt();
        remoteRelayState = val;

        // Enviar comando LoRa
        char cmd[20];
        snprintf(cmd, sizeof(cmd), "CMD:RELAY=%d", remoteRelayState);

        Serial.print("Enviando comando LoRa -> ");
        Serial.println(cmd);

        Radio.Send((uint8_t *)cmd, strlen(cmd));
    }
}

// ===================== RECONEXI√ìN THINGSBOARD =====================
void reconnectThingsBoard() {
    while (!client.connected()) {
        Serial.print("Conectando MQTT ThingsBoard...");

        if (client.connect("ESP32Receptor", access_token, NULL)) {
            Serial.println("Conectado");

            // Suscribir a RPC
            client.subscribe("v1/devices/me/rpc/request/+");
            client.setCallback(rpcCallback);
        } else {
            Serial.print("Fall√≥, rc=");
            Serial.print(client.state());
            Serial.println(" Reintentando en 5 segundos...");
            delay(5000);
        }
    }
}

// ========================= ENV√çO MQTT =========================
void sendData() {

    String payload = "{"
        "\"voltage\": "     + String(testVoltage, 2) +
        ", \"current\": "    + String(testCurrent, 2) +
        ", \"power\": "      + String(testPower, 2) +
        ", \"consumption\": "+ String(testConsumption, 2) +
        ", \"fwd\": "        + String(testFWD, 2) +
        ", \"rfl\": "        + String(testRFL, 2) +
        ", \"swr\": "        + String(testSWR, 2) +
        ", \"temperature\": "+ String(testTemperature, 2) +
        ", \"humidity\": "   + String(testHumidity, 2) +
        ", \"relay\": "      + String(testSSR) +
    "}";

    client.publish("v1/devices/me/telemetry", payload.c_str());

    Serial.println("‚Üí Telemetr√≠a enviada a ThingsBoard");
    Serial.println(payload);
}

// ========================= SETUP =========================
void setup() {
    Serial.begin(115200);
    Mcu.begin(HELTEC_BOARD, SLOW_CLK_TPYE);

    setup_wifi();
    client.setServer(mqtt_server, mqtt_port);

    // Config LORA
    RadioEvents.RxDone = OnRxDone;
    Radio.Init(&RadioEvents);
    Radio.SetChannel(RF_FREQUENCY);

    Radio.SetRxConfig(
        MODEM_LORA, LORA_BANDWIDTH, LORA_SF, LORA_CR,
        0, LORA_PREAMBLE_LENGTH, LORA_SYMBOL_TIMEOUT,
        LORA_FIX_LENGTH_PAYLOAD_ON, 0, true, 0, 0, LORA_IQ_INVERSION_ON, true
    );
}

// =========================== LOOP =========================
void loop() {

    if (!client.connected()) reconnectThingsBoard();
    client.loop();

    // ========== üïí ENV√çO CADA 5 SEGUNDOS ==========
    unsigned long now = millis();
    if (now - lastSend >= sendInterval) {
        lastSend = now;
        sendData();
    }

    // ========== LORA RX ==========
    if (lora_idle) {
        lora_idle = false;
        Radio.Rx(0);
    }

    Radio.IrqProcess();
}

// ========================= OnRxDone =========================
void OnRxDone(uint8_t *payload, uint16_t size, int16_t rssi, int8_t snr) {

    memcpy(rxpacket, payload, size);
    rxpacket[size] = '\0';
    Radio.Sleep();

    Serial.printf("\nPaquete recibido: \"%s\"\n", rxpacket);

    int parsed = sscanf(
        rxpacket,
        "V:%f,C:%f,P:%f,Cons:%f,FWD:%f,RFL:%f,SWR:%f,T:%f,H:%f,SSR:%d",
        &testVoltage, &testCurrent, &testPower, &testConsumption,
        &testFWD, &testRFL, &testSWR,
        &testTemperature, &testHumidity,
        &testSSR
    );

    if (parsed == 10) {
        Serial.println("Datos LoRa parseados OK");
    }

    Serial.println(rxpacket);  // ENV√çO AL DISPLAY DEL ESP32 AP

    lora_idle = true;
}
