#include <LoRaWan_APP.h>
#include <Wire.h>
#include <SPI.h>
#include "DHT.h"
#include <ADS1115_WE.h>
#include <WiFi.h>
#include <HTTPClient.h>

// -------------------------- CONFIG WIFI (Display AP) --------------------------
const char* WIFI_SSID = "Display_AP";
const char* WIFI_PASS = "12345678";

// IP fija del ESP32 Display (si usas AP)
#define DISPLAY_IP "http://192.168.4.1/telemetry?"

WiFiServer server(80);

// -------------------------- CONFIG LORA --------------------------
#define RF_FREQUENCY 915000000
#define TX_OUTPUT_POWER 7
#define LORA_BW 0
#define LORA_SF 7
#define LORA_CR 1

// -------------------------- SENSORES --------------------------
#define DHTPIN 14
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

ADS1115_WE ads = ADS1115_WE(0x48);

// AD7705 (ZMPT101B)
#define AD7705_DRDY 34
#define AD7705_MISO 19
#define AD7705_MOSI 23
#define AD7705_SCLK 18
#define AD7705_CS   5

// RF inputs
#define FWD_PIN 36
#define RFL_PIN 39

// Relay SSR
#define RELAY_PIN 12

// Intervalo de envío telemetría
unsigned long lastSendTime = 0;
const unsigned long sendInterval = 5000;

// Variables medidas
float voltage = 0;
float current = 0;
float power = 0;
float consumption_wh = 0;

float fwdPower = 0;
float rflPower = 0;
float swr = 1.0;

float temperature = 0;
float humidity = 0;

bool relayStatus = false;
bool safetyLock = false;

// LoRa Events
static RadioEvents_t RadioEvents;

// -------------------------- FUNCIONES ADC --------------------------

long readAD7705() {
    digitalWrite(AD7705_CS, LOW);
    delayMicroseconds(3);
    long value = 0;
    for (int i = 0; i < 16; i++) {
        value <<= 1;
        digitalWrite(AD7705_SCLK, HIGH);
        delayMicroseconds(1);
        if (digitalRead(AD7705_MISO)) value++;
        digitalWrite(AD7705_SCLK, LOW);
        delayMicroseconds(1);
    }
    digitalWrite(AD7705_CS, HIGH);
    return value;
}

float readVoltage() {
    long raw = readAD7705();
    float v = (raw * 5.0 / 65535.0) * 220;
    return v;
}

float readCurrent() {
    float voltage = ads.getResult_mV() / 1000.0;
    float offset = 2.5;
    float sensitivity = 0.066;
    float current = (voltage - offset) / sensitivity;
    return current;
}

float readRFPower(int pin) {
    int adc = analogRead(pin);
    float volts = adc * (3.3 / 4095.0);
    return volts * 100.0;
}

float calculateSWR(float FWD, float RFL) {
    if (FWD <= 0) return 1;
    float rho = sqrt(RFL / FWD);
    return (1 + rho) / (1 - rho);
}

// -------------------------- PROTECCIONES --------------------------
void aplicarProtecciones() {

    bool failV = (voltage < 200.0 || voltage > 240.0);
    bool failI = (current > 10.0);

    if (failV || failI) {
        safetyLock = true;
        relayStatus = false;
        digitalWrite(RELAY_PIN, LOW);

        Serial.println("⚠ PROTECCIÓN ACTIVADA — RELÉ DESACTIVADO");
    } else {
        safetyLock = false;
    }
}

// -------------------------- RECEPCIÓN COMANDOS LORA --------------------------

void OnRxDone(uint8_t *payload, uint16_t size, int16_t rssi, int8_t snr) {
    payload[size] = '\0';
    String cmd = String((char*)payload);

    Serial.print("CMD LoRa -> ");
    Serial.println(cmd);

    if (cmd.startsWith("CMD:RELAY=")) {
        int state = cmd.substring(11).toInt();

        if (!safetyLock) {
            relayStatus = (state == 1);
            digitalWrite(RELAY_PIN, relayStatus ? HIGH : LOW);
        }
        Serial.printf("Relé cambiado por LoRa → %d\n", relayStatus);
    }

    Radio.Rx(0);
}

void OnTxDone() {
    Radio.Rx(0);
}

// -------------------------- SETUP LORA --------------------------
void setupLoRa() {
    RadioEvents.TxDone = OnTxDone;
    RadioEvents.RxDone = OnRxDone;
    Radio.Init(&RadioEvents);

    Radio.SetChannel(RF_FREQUENCY);
    Radio.SetTxConfig(MODEM_LORA, TX_OUTPUT_POWER, 0, LORA_BW,
                      LORA_SF, LORA_CR, 8, false, true,
                      0, 0, false, 3000);

    Radio.Rx(0);
}

// -------------------------- RECEPCIÓN DISPLAY (WiFi) --------------------------

void recibirComandoWiFi() {

    WiFiClient client = server.available();
    if (!client) return;

    String req = client.readStringUntil('\r');
    client.flush();

    if (req.indexOf("/relay?state=") != -1) {

        int pos = req.indexOf("state=");
        int newState = req.substring(pos + 6).toInt();

        if (!safetyLock) {
            relayStatus = (newState == 1);
            digitalWrite(RELAY_PIN, relayStatus ? HIGH : LOW);
        }

        Serial.printf("Relé modificado desde Display → %d\n", relayStatus);
    }

    client.println("HTTP/1.1 200 OK");
    client.println("Content-Type: text/plain");
    client.println("Connection: close");
    client.println();
    client.println(relayStatus ? "1" : "0");
    client.stop();
}

// -------------------------- ENVÍO TELEMETRÍA AL DISPLAY --------------------------

void enviarDatosAlDisplay() {

    if (WiFi.status() != WL_CONNECTED) return;

    HTTPClient http;

    String url = String(DISPLAY_IP) +
        "V=" + String(voltage, 2) +
        "&C=" + String(current, 2) +
        "&P=" + String(power, 2) +
        "&Cons=" + String(consumption_wh, 2) +
        "&FWD=" + String(fwdPower, 2) +
        "&RFL=" + String(rflPower, 2) +
        "&SWR=" + String(swr, 2) +
        "&T=" + String(temperature, 1) +
        "&H=" + String(humidity, 1) +
        "&SSR=" + String(relayStatus ? 1 : 0);

    http.begin(url);
    int httpCode = http.GET();
    http.end();

    Serial.printf("Telemetría enviada al Display (%d)\n", httpCode);
}

// -------------------------- SETUP --------------------------
void setup() {

    Serial.begin(115200);
    Mcu.begin(HELTEC_BOARD, SLOW_CLK_TPYE);

    pinMode(RELAY_PIN, OUTPUT);
    digitalWrite(RELAY_PIN, LOW);

    dht.begin();
    ads.init();

    pinMode(AD7705_CS, OUTPUT);
    pinMode(AD7705_MISO, INPUT);
    pinMode(AD7705_MOSI, OUTPUT);
    pinMode(AD7705_SCLK, OUTPUT);

    setupLoRa();

    // ---------------- WIFI → Conectar al Display ----------------
    WiFi.mode(WIFI_STA);
    WiFi.begin(WIFI_SSID, WIFI_PASS);

    Serial.print("Conectando al Display AP ");

    while (WiFi.status() != WL_CONNECTED) {
        delay(500);
        Serial.print(".");
    }

    Serial.println("\nConectado al Display");
    Serial.print("IP local: ");
    Serial.println(WiFi.localIP());

    server.begin();

    Serial.println("Transmisor LoRa — Inicializado OK");
}

// -------------------------- LOOP --------------------------
void loop() {

    unsigned long now = millis();

    recibirComandoWiFi();   // Recibir control del display

    if (now - lastSendTime >= sendInterval) {

        voltage = readVoltage();
        current = readCurrent();
        power = voltage * current;

        consumption_wh += (power / 3600.0) * 5.0;

        temperature = dht.readTemperature();
        humidity = dht.readHumidity();

        fwdPower = readRFPower(FWD_PIN);
        rflPower = readRFPower(RFL_PIN);
        swr = calculateSWR(fwdPower, rflPower);

        aplicarProtecciones();

        char txPacket[200];
        snprintf(txPacket, sizeof(txPacket),
            "V:%.2f,C:%.2f,P:%.2f,Cons:%.2f,FWD:%.2f,RFL:%.2f,SWR:%.2f,T:%.1f,H:%.1f,SSR:%d",
            voltage, current, power, consumption_wh,
            fwdPower, rflPower, swr,
            temperature, humidity,
            relayStatus ? 1 : 0
        );

        Serial.printf("TX LoRa -> %s\n", txPacket);

        Radio.Send((uint8_t *)txPacket, strlen(txPacket));

        // ---- ENVÍO DE TELEMETRÍA AL DISPLAY ----
        enviarDatosAlDisplay();

        lastSendTime = now;
    }
}


